<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>أسعار الذهب — 18 و 21 قيراط (دولار/غرام)</title>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4797992845421121" crossorigin="anonymous"></script>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#d4af37">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png" sizes="180x180">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <!-- Hint the browser early -->
<link rel="preconnect" href="https://api.gold-api.com" crossorigin>
<link rel="preconnect" href="https://www.gold-api.com" crossorigin>


  <style>
  :root{
    --bg:#1c140b; --bg2:#120d07; --card:#211a0e; --ink:#fff7e6; --muted:#e8d9b3;
    --gold:#d4af37; --gold2:#b88a1a; --radius:16px; --gap:7px;  --bar-font: clamp(.98rem, .9rem + .35vw, 1.15rem);
  --bar-pad-y: 14px;
  --bar-pad-x: 18px;
  --bar-gap: 12px;
  --bar-icon: 28px;
  --bar-close: 32px;
  --bar-btn-py: 8px;
  --bar-btn-px: 16px;

  }
  *{box-sizing:border-box}
  html,body{max-width:100%}
  body{
    margin:0; color:var(--ink);
    background:
      radial-gradient(1100px 520px at 110% -10%, rgba(212,175,55,.18), transparent 60%),
      radial-gradient(800px 520px at -10% -10%, rgba(184,138,26,.18), transparent 60%),
      linear-gradient(180deg,var(--bg) 0%,var(--bg2) 100%);
    font-family:"Noto Naskh Arabic","Segoe UI",system-ui,-apple-system,Arial;
    min-height:100vh;
  }
  header{position:sticky;top:0;z-index:10;backdrop-filter:blur(8px);
    background:linear-gradient(180deg, rgba(36,26,14,.85), rgba(28,20,11,.85));
    border-bottom:1px solid rgba(212,175,55,.35); padding:18px 16px; text-align:center}
  header h1{margin:0;font-size:20px}
  header p{margin:6px 0 0;color:var(--muted);font-size:12px}
  main{max-width:980px;margin:20px auto;padding:0 16px 40px}
  .grid{display:grid;gap:var(--gap)}
  @media(min-width:900px){.grid-2{grid-template-columns:1.2fr .8fr}}
  .card{background:linear-gradient(180deg,#2b1f10 0%,var(--card) 100%);
    border:1px solid rgba(212,175,55,.25); border-radius:var(--radius); padding:16px;
    box-shadow:0 12px 30px rgba(0,0,0,.35)}
  h2{margin:0 0 6px;font-size:17px}
  label{display:block;color:var(--muted);font-size:13px;margin:0 0 6px}

  /* Inputs: glow + placeholder */
  input{
    width:100%;
    background:#171008;
    color:var(--ink);
    border:1px solid rgba(212,175,55,.45);
    padding:12px;
    border-radius:12px;
    outline:none;
    caret-color:var(--ink);
    box-shadow:0 0 6px rgba(212,175,55,.25);
    transition:all .25s ease;
  }
  input:focus{
    border-color:var(--gold);
    box-shadow:0 0 10px rgba(212,175,55,.55);
  }
  input::placeholder{ color:rgba(212,175,55,.55); font-style:italic }
  input:hover{ border-color:var(--gold2); box-shadow:0 0 8px rgba(212,175,55,.35) }

  .num{direction:ltr;text-align:left}
  .row{display:grid;gap:10px;grid-template-columns:1fr 160px;align-items:end}
  .btn{border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:800;
    background:linear-gradient(135deg,var(--gold),var(--gold2));color:#2b1f10;
    box-shadow:0 10px 22px rgba(212,175,55,.35)}
  .btn.ghost{background:transparent;color:var(--ink);border:1px solid rgba(212,175,55,.35)}
  .btn-mini{border:1px solid rgba(212,175,55,.35);background:#171008;color:var(--ink);
    border-radius:10px;padding:6px 10px;cursor:pointer;font-size:12px}
  .btn-mini.gold{background:linear-gradient(135deg,var(--gold),var(--gold2));color:#2b1f10;border:0}
  .badge{display:inline-block;padding:4px 10px;border-radius:999px;background:#171008;border:1px solid rgba(212,175,55,.25);color:var(--muted);font-size:12px}
  .out{font-family:ui-monospace,Menlo,Consolas,monospace;line-height:1.6;background:#171008;border:1px solid rgba(212,175,55,.22);padding:12px;border-radius:12px}
  .error{background:#3a120c;border:1px solid rgba(255,150,120,.6);color:#ffe1db;padding:10px;border-radius:10px;font-size:12px}
  .totals-grid{display:grid;gap:10px}
  @media(min-width:700px){.totals-grid{grid-template-columns:1fr 1fr}}
  .panel{background:#1f150a;border:1px solid rgba(212,175,55,.28);border-radius:14px;padding:12px}
  .tot{margin-top:10px;background:#0f0a05;border:1px solid rgba(212,175,55,.28);border-radius:12px;padding:10px 12px;font-size:20px;text-align:center;letter-spacing:.3px}
  .mini{font-size:12px;color:var(--muted)}

  /* switch */
  .switch{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none}
  .switch input{display:none}
  .slider{position:relative;width:44px;height:24px;border-radius:999px;background:#4b3a22;border:1px solid rgba(212,175,55,.35);transition:.25s}
  .slider::after{content:"";position:absolute;top:50%;left:2px;transform:translateY(-50%);width:20px;height:20px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold2));transition:.25s;box-shadow:0 4px 10px rgba(0,0,0,.35)}
  .switch input:checked + .slider{background:#c0992b}
  .switch input:checked + .slider::after{transform:translate(20px,-50%)}
  .switch .txt{font-size:12px;color:var(--muted)}

  /* prices grid */
  .prices{display:grid;grid-template-columns:auto 1fr;gap:6px 16px;align-items:center;white-space:normal;font-family:inherit}
  .prices > div{padding:4px 0;border-bottom:1px dashed rgba(212,175,55,.18)}
  .prices > div:nth-last-child(-n+2){border-bottom:none}
  .prices .label{color:var(--muted);font-size:14px}
  .prices .value{font-weight:700;direction:ltr;text-align:left}

  /* coin image */
  .coin-img{display:block;width:500px;max-width:100%;height:auto;margin:6px auto;border-radius:10px;border:1px solid rgba(212,175,55,.25);background:#0b0b0b;box-shadow:0 6px 16px rgba(0,0,0,.35);object-fit:contain}
  @media(min-width:700px){ .coin-img{ width:500px } }

  /* compact boxes */
  #coin{white-space:normal;line-height:1.25;padding:6px 8px}
  #coin .prices{gap:2px 10px}
  #coin .prices > div{padding:0}
  #coin .coin-img{margin:4px auto}
  #coin .mini{margin-top:2px;line-height:1.2}
  .card h2{margin-bottom:6px}
  #perg{margin-block:6px;padding:6px 10px;line-height:1.25;white-space:normal}
  #perg .prices{gap:2px 12px}
  #perg .prices > div{padding:2px 0}
  #perg .label{font-size:13px}
  .card h2 + #perg{margin-top:6px}

  /* contact bar */
  .contact-bar{display:flex;align-items:center;gap:12px;padding:10px 12px;margin:8px 0;background:#1f150a;border:1px solid rgba(212,175,55,.28);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.25);direction:rtl;font-size:14px;color:var(--ink)}
  .contact-bar .icon{width:18px;height:18px;flex:0 0 18px;display:inline-block}
  .contact-bar a{color:var(--gold);text-decoration:none;border-bottom:1px dashed rgba(212,175,55,.4)}
  .contact-bar .spacer{flex:1}

  /* ---------- Fixes ---------- */
  .card,.panel,.out,.contact-bar,.prices,.totals-grid{min-width:0}
  .prices .value{min-width:0; overflow-wrap:anywhere}
  .contact-bar a{overflow-wrap:anywhere}
  #formulaBox{white-space:pre; overflow-x:auto; direction:ltr; text-align:left; -webkit-overflow-scrolling:touch}
  footer{padding-bottom:calc(18px + env(safe-area-inset-bottom))}
  body.no-scroll{height:100vh; overflow:hidden}
 body.has-topbar{ padding-top:68px }



  /* ---------- Settings modal ---------- */
  #cfgPanel{position:fixed; inset:0; z-index:1000; display:none}
  #cfgPanel.open{display:block}
  #cfgPanel::before{content:""; position:absolute; inset:0; background:rgba(0,0,0,.55)}
  #cfgPanel .cfg-sheet{
    position:relative; margin:6vh auto 0; width:min(860px,94vw);
    max-height:86vh; overflow:auto; background:#1f150a;
    border:1px solid rgba(212,175,55,.28); border-radius:14px; padding:14px;
    box-shadow:0 20px 50px rgba(0,0,0,.5)
  }
  #cfgPanel .cfg-head{display:flex;align-items:center;justify-content:space-between;gap:10px}

/* ---------- A2HS Banner (BIGGER + RESPONSIVE) ---------- */
#a2hsBanner{
  position:fixed; top:0; left:0; right:0; z-index:9999;
  transform:translateY(-110%); transition:transform .45s ease;
  background:#3a2a16; color:#fff7e6;
  border-bottom:1px solid rgba(212,175,55,.35);
  box-shadow:0 10px 30px rgba(0,0,0,.35);
  font-size: var(--bar-font);
}
#a2hsBanner.show{ transform:translateY(0) }

#a2hsBanner .wrap{
  max-width:1100px; margin:0 auto;
  padding: var(--bar-pad-y) var(--bar-pad-x);
  display:flex; align-items:center; gap: var(--bar-gap);
}

#a2hsBanner img.icon{
  width: var(--bar-icon); height: var(--bar-icon);
  border-radius:6px; flex:0 0 var(--bar-icon);
}

#a2hsBanner .txt{
  flex:1; line-height:1.35;
}

#a2hsBanner .cta{
  background:linear-gradient(135deg,var(--gold),var(--gold2));
  color:#2b1f10; border:0; border-radius:999px;
  padding: var(--bar-btn-py) var(--bar-btn-px);
  font-weight:800; cursor:pointer; font-size:1em;
}

#a2hsBanner .close{
  background:transparent; color:#fff7e6; border:0;
  width: var(--bar-close); height: var(--bar-close);
  font-size: calc(var(--bar-close) * 0.56);
  line-height: var(--bar-close);
  cursor:pointer; flex:0 0 var(--bar-close);
}

/* Small phones: tiny bump */
@media (max-width: 380px){
  :root{
    --bar-font: clamp(1rem, .95rem + .6vw, 1.2rem);
    --bar-pad-y: 16px;
  }
}


  /* ---------- A2HS Guide Modal ---------- */
  /* center the modal */
#a2hsModal{
  position:fixed; inset:0; z-index:10001;
  display:none;
  align-items:center;            /* vertical centering */
  justify-content:center;        /* horizontal centering */
  padding:24px 12px;             /* safe breathing room on small screens */
}
#a2hsModal.open{ display:flex }   /* show + keep flex centering */

  #a2hsModal::before{content:""; position:absolute; inset:0; background:rgba(0,0,0,.6)}
  #a2hsModal .sheet{
  position:relative;
  margin:0;                         /* no push from the top */
  width:min(680px,92vw);
  max-height:calc(100vh - 48px);    /* fit viewport height minus the overlay padding */
  overflow:auto;                    /* scroll if content is taller */
  background:#1f150a; color:var(--ink);
  border:1px solid rgba(212,175,55,.28); border-radius:16px; padding:14px;
  box-shadow:0 20px 50px rgba(0,0,0,.65);
}

  #a2hsModal .sheet h3{margin:0 0 8px}
  #a2hsModal .sheet img.main{display:block; width:100%; height:auto; border-radius:10px; border:1px solid rgba(212,175,55,.22); background:#0b0b0b}
  #a2hsModal .steps{margin-top:10px; font-size:14px; line-height:1.7}
  #a2hsModal .steps .row{display:flex; align-items:center; gap:10px; margin:6px 0}
  #a2hsModal .steps img.icon{width:22px; height:22px}
  #a2hsModal .x{position:absolute; top:8px; left:10px; background:transparent; border:0; color:var(--ink); font-size:20px; cursor:pointer}
  /* --- CLS guards --- */
/* Keep the "آخر تحديث" bubble width stable (20 mono chars) */
#last { font-variant-numeric: tabular-nums; min-width: 18ch; text-align: start }

/* Each prices row keeps its height even while numbers change */
.prices .value, .prices .label { line-height: 1.6 }
.prices .value { min-height: 1.6em; display: inline-block }

/* Totals blocks get a fixed minimum height */
.tot { min-height: 2.2em }

/* Prefer reduced motion = fewer heavy transitions on low devices */
@media (prefers-reduced-motion: reduce){
  * { transition: none !important; animation: none !important }
}

  </style>
</head>

<body>

  <!-- A2HS Banner -->
  <div id="a2hsBanner" aria-hidden="true">
    <div class="wrap">
      <button class="close" type="button" aria-label="إغلاق">×</button>
      <img class="icon" src="icons/icon-192.png" alt="">
      <div class="txt">احصل على النسخة السريعة — أضِف الموقع إلى الشاشة الرئيسية.</div>
      <button class="cta" type="button" id="a2hsGet">الحصول</button>
    </div>
  </div>

  <!-- A2HS Guide Modal -->
  <div id="a2hsModal" aria-hidden="true">
    <div class="sheet" role="dialog" aria-modal="true" aria-labelledby="a2hsTitle">
      <button class="x" type="button" aria-label="إغلاق">×</button>
      <h3 id="a2hsTitle">إضافة إلى الشاشة الرئيسية</h3>
      <img class="main" src="assets/save_to_home_screen.jpg" alt="شرح إضافة إلى الشاشة الرئيسية">
      <div class="steps">
        <div class="row"><strong>1.</strong> اضغط <em>مشاركة</em> <img class="icon" src="assets/share.jpg" alt=""></div>
        <div class="row"><strong>2.</strong> اختر <em>Add to Home Screen</em> ثم <em>تثبيت</em>.</div>
      </div>
    </div>
  </div>

  <header>
    <h1>أسعار الذهب — 18 قيراط و 21 قيراط (دولار/غرام)</h1>
   <p>حاليًا نحدّث السعر تلقائيًا كل 10 ثوانٍ. إذا أردت الإدخال يدويًا، أوقف التحديث التلقائي ثم اكتب سعر الأونصة.</p>

 
  </header>

  <main class="grid grid-2">
    <!-- Ounce price -->
    <section class="card">
      <h2>سعر الأونصة بالدولار</h2>

      <div class="spot-toolbar" style="display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end">
        <div class="priceField" style="flex:1 1 180px;min-width:170px">
          <label>USD/oz (إدخال يدوي)</label>
          <input id="oz" class="num" type="tel" inputmode="decimal" placeholder="مثال: 2350" value="">
        </div>

        <button id="btnFetch" class="btn">تحديث • Refresh</button>

        <label class="switch" aria-label="تحديث تلقائي" title="تحديث تلقائي كل 10 ثوانٍ">
          <input id="auto" type="checkbox" checked>
          <span class="slider" aria-hidden="true"></span>
          <span class="txt">تحديث تلقائي</span>
        </label>

      </div>

      <div class="spot-meta" style="display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap">
        <span id="meta" class="badge">—</span>
        <span id="last" class="badge" aria-live="polite" title="وقت آخر تحديث">آخر تحديث: —</span>
        <span class="spacer"></span>
      </div>

      <div id="err" class="error" style="display:none;margin-top:8px"></div>
    </section>

    <!-- Basic per-gram prices + coin -->
    <section class="card">
      <h2>الأسعار الأساسية من دون صياغة (دولار/غرام)</h2>

      <div class="out" id="perg">
        <div class="prices">
  <div class="label">مبيع 18K</div><div class="value">$ <span id="s18">—</span> / غ</div>
  <div class="label">شراء 18K</div><div class="value">$ <span id="b18">—</span> / غ</div>
  <div class="label">مبيع 21K</div><div class="value">$ <span id="s21">—</span> / غ</div>
  <div class="label">شراء 21K</div><div class="value">$ <span id="b21">—</span> / غ</div>
</div>

      </div>

      <!-- contact line -->
      <div class="contact-bar" role="note" aria-label="التواصل للإعلانات">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M20 4H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2Zm0 4-8 5L4 8V6l8 5 8-5v2Z"/>
        </svg>
        <div>
          <strong>لإعلاناتكم:</strong>
          التواصل عبر البريد الإلكتروني
          <a id="adEmail" href="mailto:ajouni178@gmail.com">ajouni178@gmail.com</a>
        </div>
        <span class="spacer"></span>
        <button id="copyAdMail" class="btn-mini gold" type="button">نسخ الإيميل</button>
      </div>

      <h2 style="margin-top:4px">ليرة ذهبية أنجليزية ٨ غ عيار ٢١</h2>
      <div class="out" id="coin">
        <div class="prices" id="coinPrices">
         <div class="label">ليرة — مبيع</div><div class="value">$ <span id="coinSell">—</span></div>
         <div class="label">ليرة — شراء</div><div class="value">$ <span id="coinBuy">—</span></div>
        </div>

        <picture>
          <source type="image/avif" srcset="assets/coin_photo_627x300.avif">
          <source type="image/webp" srcset="assets/coin_photo_627x300.webp">
          <img class="coin-img"
               src="assets/coin_photo_627x300.png"
               alt="ليرة ذهبية إنجليزية ٨ غرام عيار ٢١ — الوجه والظهر"
               width="627" height="300"
               loading="lazy" decoding="async" fetchpriority="low">
        </picture>

        <div class="mini" id="coinRule">مبيع = ٨ × مبيع ٢١ /غ<br>شراء = ٨ × شراء ٢١ /غ + ٨ دولار.</div>
      </div>
    </section>

    <!-- Totals -->
    <section class="card" style="grid-column:1 / -1">
      <h2>حساب الإجمالي حسب الوزن</h2>

      <div class="totals-grid" style="margin-top:8px">
        <div class="panel">
          <h2>مبيع 18 قيراط</h2>
          <div class="row">
            <div>
              <label>الوزن (غ)</label>
              <input id="w_s18" class="num" type="tel" inputmode="decimal" placeholder="أدخل الوزن هنا">
            </div>
            <div style="visibility:hidden">
              <label>صياغة</label>
              <input disabled class="num" placeholder="أدخل الوزن هنا">
            </div>
          </div>
          <div id="t_s18" class="tot">الإجمالي: —</div>
        </div>

        <div class="panel">
          <h2>
    شراء 18 قيراط
    <small style="display:block;font-size:12px;color:var(--muted);font-weight:normal">
      (رسوم المحل مضافة قبل الصياغة — يمكن تعديلها في الأسفل)
    </small>
  </h2>
          <div class="row">
            <div>
              <label>الوزن (غ)</label>
              <input id="w_b18" class="num" type="tel" inputmode="decimal" placeholder="أدخل الوزن هنا">
            </div>
            <div>
              <label>صياغة (0–50 $/غ)</label>
              <input id="add18" class="num" type="tel" inputmode="decimal" step="0.01" placeholder=" أدخل الصياغة هنا">
            </div>
          </div>
          <div id="t_b18" class="tot">الإجمالي: —</div>
        </div>

        <div class="panel">
          <h2>مبيع 21 قيراط</h2>
          <div class="row">
            <div>
              <label>الوزن (غ)</label>
              <input id="w_s21" class="num" type="tel" inputmode="decimal" placeholder="أدخل الوزن هنا">
            </div>
            <div style="visibility:hidden">
              <label>صياغة</label>
              <input disabled class="num" placeholder="">
            </div>
          </div>
          <div id="t_s21" class="tot">الإجمالي: —</div>
        </div>

        <div class="panel">
           <h2>
    شراء 21 قيراط
    <small style="display:block;font-size:12px;color:var(--muted);font-weight:normal">
      (رسوم المحل مضافة قبل الصياغة — يمكن تعديلها في الأسفل)
    </small>
  </h2>
          <div class="row">
            <div>
              <label>الوزن (غ)</label>
              <input id="w_b21" class="num" type="tel" inputmode="decimal" placeholder="أدخل الوزن هنا">
            </div>
            <div>
              <label>صياغة (0–50 $/غ)</label>
              <input id="add21" class="num" type="tel" inputmode="decimal" step="0.01" placeholder="أدخل الصياغة هنا">
            </div>
          </div>
          <div id="t_b21" class="tot">الإجمالي: —</div>
        </div>
      </div>
    </section>

    <!-- Formulas + a button that opens a modal -->
    <section class="card" style="grid-column:1 / -1">
      <div class="bar-head" style="margin-bottom:8px">
        <h2>الصيغ المستخدمة</h2>
        <div class="bar-actions">
          <span class="badge hint">يمكنك تعديل طريقة الحساب بالضغط على هذا الزر</span>
          <button id="toggleCfg" class="btn-mini gold" type="button" title="تحرير القيم">تعديل القيم</button>
        </div>
      </div>
      <div id="formulaBox" class="out" style="direction:ltr;text-align:left"></div>
    </section>
  </main>

  <!-- Settings modal -->
  <div id="cfgPanel" aria-hidden="true">
    <div class="cfg-sheet" role="dialog" aria-modal="true" aria-labelledby="cfgTitle">
      <div class="cfg-head">
        <h3 id="cfgTitle" style="margin:0">إعدادات المحل (تُحفَظ محليًا في هذا المتصفح)</h3>
        <button class="btn-mini" type="button" data-close>إغلاق</button>
      </div>

      <div class="settings-grid" style="margin-top:10px">
        <div class="settings-row"><label>التحويل: غرام/أونصة</label><input id="c_ozt" class="num" type="number" step="0.001" min="28" max="35"></div>
        <div class="settings-row"><label>فرق السعر للمبيع (oz − …)</label><input id="c_spreadMinus" class="num" type="number" step="0.1" min="0" max="200"></div>
        <div class="settings-row"><label>فرق السعر للشراء (oz + …)</label><input id="c_spreadPlus" class="num" type="number" step="0.1" min="0" max="200"></div>

        <div class="settings-row"><label>18K مبيع — البهار (%)</label><input id="c_k18s" class="num" type="number" step="1" min="600" max="999"></div>
        <div class="settings-row"><label>18K مبيع — المقام (÷)</label><input id="c_k18s_den" class="num" type="number" step="1" min="600" max="1200"></div>

        <div class="settings-row"><label>18K شراء — البهار (%)</label><input id="c_k18b" class="num" type="number" step="1" min="600" max="999"></div>
        <div class="settings-row"><label>18K شراء — المقام (÷)</label><input id="c_k18b_den" class="num" type="number" step="1" min="600" max="1200"></div>

        <div class="settings-row"><label>21K مبيع — البهار (%)</label><input id="c_k21s" class="num" type="number" step="1" min="700" max="999"></div>
        <div class="settings-row"><label>21K مبيع — المقام (÷)</label><input id="c_k21s_den" class="num" type="number" step="1" min="700" max="1200"></div>

        <div class="settings-row"><label>21K شراء — البهار (%)</label><input id="c_k21b" class="num" type="number" step="1" min="700" max="999"></div>
        <div class="settings-row"><label>21K شراء — المقام (÷)</label><input id="c_k21b_den" class="num" type="number" step="1" min="700" max="1200"></div>

        <div class="settings-row"><label>وزن الليرة (غ)</label><input id="c_coinW" class="num" type="number" step="0.01" min="1" max="50"></div>
        <div class="settings-row"><label>رسوم شراء الليرة (دولار)</label><input id="c_coinFee" class="num" type="number" step="0.1" min="0" max="200"></div>
        <div class="settings-row"><label>هامش المحل (رسوم $/غ قبل الصياغة)</label><input id="c_margin" class="num" type="number" step="0.1" min="0" max="50"></div>
      </div>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button id="btnSaveCfg" class="btn-mini gold" type="button">حفظ</button>
        <button id="btnResetCfg" class="btn-mini" type="button">إرجاع الافتراضي</button>
        <button id="btnCopyCfg" class="btn-mini" type="button" title="ينسخ القيم كـ JSON">نسخ الإعدادات</button>
        <span class="spacer"></span>
        <button class="btn-mini" type="button" data-close>إغلاق</button>
      </div>

      <div class="settings-note" style="margin-top:8px">الملاحظة: تُحفَظ هذه القيم على هذا الجهاز فقط (localStorage). لإلغاءها استخدم زر الإرجاع.</div>
    </div>
  </div>

  <footer style="text-align:center;color:var(--muted);font-size:12px;padding:18px 0;">
    © <span id="y"></span> <strong>goldpricelb.store</strong> — جميع الحقوق محفوظة — صُمِّم بواسطة علي جوني (Ali Jouni).
  </footer>

  <script>
  /* =========================
     Helpers
     ========================= */
     // Cache output spans once
    const outRefs = {};
    function bindOutputs(){
  ["s18","b18","s21","b21","coinSell","coinBuy"].forEach(id => outRefs[id] = document.getElementById(id));
    }
    function setOut(id, val){ if(outRefs[id]) outRefs[id].textContent = fmt(val); }

  const $ = id => document.getElementById(id);
  const fmt = n => isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:2}) : "—";
  const cleanDec = s => (s||"").replace(/[^\d.,-]/g,"").replace(",",".");
  const fval = id => { const v = parseFloat(cleanDec($(id).value)); return isFinite(v)? v : NaN; };
  const clamp = (x,min,max)=> Math.min(max, Math.max(min, x));

  // Format date & time for the "آخر تحديث" bubble
  function fmtDateTime(d = new Date()){
    try{
      return d.toLocaleString(undefined, {
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit'
      });
    }catch{
      return d.toISOString().replace('T',' ').slice(0,19);
    }
  }
  function setLastUpdated(d = new Date()){
    const el = $("last");
    if (el) el.textContent = "آخر تحديث: " + fmtDateTime(d);
  }

  /* =========================
     Per-shop config (saved)
     ========================= */
  const CFG_KEY = "gold_cfg_v1";
  const SPOT_KEY = "last_spot_v1";             // NEW: cache key for last price
  const DEFAULTS = Object.freeze({
    oztToG: 32,
    spreadMinus: 30,
    spreadPlus: 30,
    k18SellPpm: 740,   k18SellDen: 1000,
    k18BuyPpm: 750,    k18BuyDen:  995,
    k21SellPpm: 865,   k21SellDen: 1000,
    k21BuyPpm: 875,    k21BuyDen:  995,
    coinWeightG: 8,
    coinBuyFee: 8,
    storeMargin: 5.5
  });
  let cfg = loadCfg();

  function loadCfg(){
    try{
      const saved = JSON.parse(localStorage.getItem(CFG_KEY)||"null");
      if(saved && typeof saved==="object") return {...DEFAULTS, ...saved};
    }catch{}
    return {...DEFAULTS};
  }
  function saveCfg(){ try{ localStorage.setItem(CFG_KEY, JSON.stringify(cfg)); }catch{} }
  function resetCfg(){ cfg = {...DEFAULTS}; saveCfg(); bindCfgInputs(); renderFormulas(); runAll(); }

  function bindCfgInputs(){
    $("c_ozt").value = cfg.oztToG;
    $("c_spreadMinus").value = cfg.spreadMinus;
    $("c_spreadPlus").value  = cfg.spreadPlus;

    $("c_k18s").value = cfg.k18SellPpm;     $("c_k18s_den").value = cfg.k18SellDen;
    $("c_k18b").value = cfg.k18BuyPpm;      $("c_k18b_den").value = cfg.k18BuyDen;
    $("c_k21s").value = cfg.k21SellPpm;     $("c_k21s_den").value = cfg.k21SellDen;
    $("c_k21b").value = cfg.k21BuyPpm;      $("c_k21b_den").value = cfg.k21BuyDen;

    $("c_coinW").value = cfg.coinWeightG;
    $("c_coinFee").value = cfg.coinBuyFee;
    $("c_margin").value = cfg.storeMargin;
  }

  function readCfgFromInputs(){
    const v = id => parseFloat(cleanDec($(id).value));
    const nn = (x,fallback)=> (isFinite(x)?x:fallback);

    cfg.oztToG      = clamp(nn(v("c_ozt"), DEFAULTS.oztToG), 28, 35);
    cfg.spreadMinus = clamp(nn(v("c_spreadMinus"), DEFAULTS.spreadMinus), 0, 200);
    cfg.spreadPlus  = clamp(nn(v("c_spreadPlus"),  DEFAULTS.spreadPlus),  0, 200);

    cfg.k18SellPpm  = clamp(nn(v("c_k18s"), DEFAULTS.k18SellPpm),  600, 999);
    cfg.k18SellDen  = clamp(nn(v("c_k18s_den"), DEFAULTS.k18SellDen), 600, 1200);
    cfg.k18BuyPpm   = clamp(nn(v("c_k18b"), DEFAULTS.k18BuyPpm),   600, 999);
    cfg.k18BuyDen   = clamp(nn(v("c_k18b_den"), DEFAULTS.k18BuyDen), 600, 1200);

    cfg.k21SellPpm  = clamp(nn(v("c_k21s"), DEFAULTS.k21SellPpm),  700, 999);
    cfg.k21SellDen  = clamp(nn(v("c_k21s_den"), DEFAULTS.k21SellDen), 700, 1200);
    cfg.k21BuyPpm   = clamp(nn(v("c_k21b"), DEFAULTS.k21BuyPpm),   700, 999);
    cfg.k21BuyDen   = clamp(nn(v("c_k21b_den"), DEFAULTS.k21BuyDen), 700, 1200);

    cfg.coinWeightG = clamp(nn(v("c_coinW"), DEFAULTS.coinWeightG), 1, 50);
    cfg.coinBuyFee  = clamp(nn(v("c_coinFee"), DEFAULTS.coinBuyFee), 0, 500);
    cfg.storeMargin = clamp(nn(v("c_margin"), DEFAULTS.storeMargin), 0, 50);
  }

  function renderFormulas(){
    const f = (pm,ppm,den)=>`(oz ${pm>0?"+":"−"} ${Math.abs(pm)})*${cfg.oztToG}*${ppm}/${den}`;
    const lines = [
      `sell 18K = ${f(-cfg.spreadMinus, cfg.k18SellPpm, cfg.k18SellDen)}`,
      `buy  18K = ${f(+cfg.spreadPlus,  cfg.k18BuyPpm,  cfg.k18BuyDen)}`,
      `sell 21K = ${f(-cfg.spreadMinus, cfg.k21SellPpm, cfg.k21SellDen)}`,
      `buy  21K = ${f(+cfg.spreadPlus,  cfg.k21BuyPpm,  cfg.k21BuyDen)}`,
      `Coin sell = ${cfg.coinWeightG} × sell21k`,
      `Coin buy  = ${cfg.coinWeightG} × buy21k + ${cfg.coinBuyFee}`,
      `(شراء 18/21) +${cfg.storeMargin} $/غ رسوم محل قبل الصياغة`
    ].join("\n");
    $("formulaBox").textContent = lines;

    $("coinRule").innerHTML =
      `مبيع = ${cfg.coinWeightG} × مبيع ٢١ /غ<br>`+
      `شراء = ${cfg.coinWeightG} × شراء ٢١ /غ + ${fmt(cfg.coinBuyFee)} دولار.`;
  }

  /* =========================
     Pricing logic
     ========================= */
  let per = { s18:NaN, b18:NaN, s21:NaN, b21:NaN };

  function calcPerGram(){
  const oz = fval("oz");
  if(!isFinite(oz) || oz<=0) return false;

  const g = cfg.oztToG;

  per.s18 = (oz - cfg.spreadMinus) * g * (cfg.k18SellPpm / cfg.k18SellDen) / 1000;
  per.b18 = (oz + cfg.spreadPlus)  * g * (cfg.k18BuyPpm  / cfg.k18BuyDen)  / 1000;
  per.s21 = (oz - cfg.spreadMinus) * g * (cfg.k21SellPpm / cfg.k21SellDen) / 1000;
  per.b21 = (oz + cfg.spreadPlus)  * g * (cfg.k21BuyPpm  / cfg.k21BuyDen)  / 1000;

  // Update text only (no innerHTML)
  setOut("s18", per.s18);
  setOut("b18", per.b18);
  setOut("s21", per.s21);
  setOut("b21", per.b21);

  const coinSell = cfg.coinWeightG * per.s21;
  const coinBuy  = cfg.coinWeightG * per.b21 + cfg.coinBuyFee;

  setOut("coinSell", coinSell);
  setOut("coinBuy",  coinBuy);

  return true;
}


  function updateTotals(){
    if(!isFinite(per.s18)) return;

    const ws18=fval("w_s18");
    $("t_s18").textContent = "الإجمالي: " + (isFinite(ws18)? "$ "+(per.s18*ws18).toFixed(2) : "—");

    const wb18=fval("w_b18"), a18=parseFloat(cleanDec($("add18").value));
    const base18 = per.b18 + cfg.storeMargin;
    $("t_b18").textContent = "الإجمالي: " + (isFinite(wb18)? "$ "+((base18 + (isFinite(a18)?a18:0))*wb18).toFixed(2) : "—");

    const ws21=fval("w_s21");
    $("t_s21").textContent = "الإجمالي: " + (isFinite(ws21)? "$ "+(per.s21*ws21).toFixed(2) : "—");

    const wb21=fval("w_b21"), a21=parseFloat(cleanDec($("add21").value));
    const base21 = per.b21 + cfg.storeMargin;
    $("t_b21").textContent = "الإجمالي: " + (isFinite(wb21)? "$ "+((base21 + (isFinite(a21)?a21:0))*wb21).toFixed(2) : "—");
  }

  function runAll(){ if(calcPerGram()) updateTotals(); }

  /* =========================
     Fetch ounce price
     ========================= */
  const GOLDAPI_FREE_ENDPOINTS = [
    "https://api.gold-api.com/price/XAU",
    "https://api.gold-api.com/price/XAU/USD",
    "https://www.gold-api.com/price/XAU",
    "https://www.gold-api.com/price/XAU/USD"
  ];

  function pickOuncePrice(data){
    const candidates = [
      data && data.price, data && data.usd, data && data.usd_ounce,
      data && data.price_ounce, data && data.ounce, data && data.oz,
      data && data.result && data.result.price, data && data.XAU && data.XAU.USD
    ].map(Number).filter(x => isFinite(x) && x>0);
    if (candidates.length) return candidates[0];

    const g24 = Number(data && (data.gram_24k || data.price_gram_24k || data.g24 || data.per_gram));
    if (isFinite(g24) && g24>0) return g24 * cfg.oztToG;
    return NaN;
  }

  // NEW: fast parallel fetch with timeout
  function timeoutFetch(url, ms){
    const c = new AbortController();
    const id = setTimeout(() => c.abort(), ms);
    return fetch(url, { cache:"no-store", signal:c.signal })
      .finally(() => clearTimeout(id));
  }
  async function getSpotFast(){
    const tries = GOLDAPI_FREE_ENDPOINTS.map(url =>
      timeoutFetch(url, 3500)
        .then(r => r.ok ? r.json() : Promise.reject("HTTP " + r.status))
        .then(pickOuncePrice)
        .then(v => (isFinite(v) && v>0) ? v : Promise.reject("bad data"))
    );
    return Promise.any(tries);
  }

  async function fetchSpot(){
    $("btnFetch").disabled = true;
    const err = $("err"); err.style.display = "none"; err.textContent = "";
    try{
      const p = await getSpotFast();
      $("oz").value = p.toFixed(2);
      runAll();
      setLastUpdated(new Date());
      try{ localStorage.setItem(SPOT_KEY, JSON.stringify({ p, t: Date.now() })); }catch{}
    }catch(e){
      err.style.display = "block";
      err.textContent = "فشل الجلب من gold-api.com.\n" + (e && e.toString ? e.toString() : e);
    }finally{
      $("btnFetch").disabled = false;
    }
  }

  /* =========================
     Auto/inputs wiring
     ========================= */
  ["w_s18","w_b18","add18","w_s21","w_b21","add21"].forEach(id=>{
    const el = $(id); if(el) el.addEventListener("input", updateTotals);
  });
  $("oz").addEventListener("input", runAll);
  $("btnFetch").addEventListener("click", fetchSpot);

  let autoTimer = null;
  const AUTO_MS = 10_000;
 function setAuto(on){
  const btn = $("btnFetch"); const meta = $("meta"); const auto = $("auto");
  if(on){
    if(autoTimer) clearInterval(autoTimer);
    btn.disabled = true; if(meta) meta.textContent = "تحديث تلقائي كل 10 ثوانٍ";
    fetchSpot();
    autoTimer = setInterval(fetchSpot, AUTO_MS); auto.checked = true;
  }else{
    if(autoTimer){ clearInterval(autoTimer); autoTimer = null; }
    btn.disabled = false; if(meta) meta.textContent = "التحديث اليدوي مفعّل";
    auto.checked = false;
  }
}

  $("auto").addEventListener("change", e => setAuto(e.target.checked));

  /* =========================
     Settings UI wiring (modal)
     ========================= */
  const cfgModal = $("cfgPanel");
  $("toggleCfg").addEventListener("click", ()=>{
    cfgModal.classList.add("open");
    document.body.classList.add("no-scroll");
  });
  cfgModal.addEventListener("click", (e)=>{
    if (e.target === cfgModal || e.target.hasAttribute("data-close")){
      cfgModal.classList.remove("open");
      document.body.classList.remove("no-scroll");
    }
  });
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && cfgModal.classList.contains("open")){
      cfgModal.classList.remove("open");
      document.body.classList.remove("no-scroll");
    }
  });

  $("btnSaveCfg").addEventListener("click", ()=>{
    readCfgFromInputs(); saveCfg(); renderFormulas(); runAll();
  });
  $("btnResetCfg").addEventListener("click", resetCfg);
  $("btnCopyCfg").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(JSON.stringify(cfg, null, 2));
      $("btnCopyCfg").textContent = "نُسخت!"; setTimeout(()=>$("btnCopyCfg").textContent="نسخ الإعدادات",1200);
    }catch{}
  });

  /* copy email */
  (function(){
    const copyBtn = document.getElementById("copyAdMail");
    const emailEl = document.getElementById("adEmail");
    if(copyBtn && emailEl){
      const emailText = emailEl.textContent.trim();
      copyBtn.addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(emailText);
          const old = copyBtn.textContent; copyBtn.textContent = "نُسخ!"; setTimeout(()=> copyBtn.textContent = old, 1200);
        }catch{
          const ta = document.createElement("textarea");
          ta.value = emailText; document.body.appendChild(ta);
          ta.select(); document.execCommand("copy"); document.body.removeChild(ta);
          const old = copyBtn.textContent; copyBtn.textContent = "نُسخ!"; setTimeout(()=> copyBtn.textContent = old, 1200);
        }
      });
    }
  })();

  /* ============ A2HS banner logic ============ */
  (function(){
    var banner = document.getElementById('a2hsBanner');
    var getBtn = document.getElementById('a2hsGet');
    var modal = document.getElementById('a2hsModal');
    var deferredPrompt = null;
    var isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
   var bannerShown = false;
   function safeShowBanner(){ if (!bannerShown){ bannerShown = true; showBanner(); } }


   window.addEventListener('beforeinstallprompt', function(e){
  e.preventDefault();
  deferredPrompt = e;
  if (!isStandalone() && (sessionStorage.getItem('a2hs_dismissed') !== '1')){
    safeShowBanner();     // Desktop/Android: show when installable
  }
});



    function isStandalone(){
      var mql = window.matchMedia && window.matchMedia('(display-mode: standalone)').matches;
      var ios = window.navigator && window.navigator.standalone === true;
      return !!(mql || ios);
    }
function showBanner(){ banner.classList.add('show'); banner.setAttribute('aria-hidden','false'); document.body.classList.add('has-topbar'); }
function hideBanner(){ banner.classList.remove('show'); banner.setAttribute('aria-hidden','true'); document.body.classList.remove('has-topbar'); }
function openGuide(){ hideBanner(); modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); document.body.classList.add('no-scroll'); }
function closeGuide(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); document.body.classList.remove('no-scroll'); }


    banner.querySelector('.close').addEventListener('click', function(){
      hideBanner();
      try{ sessionStorage.setItem('a2hs_dismissed','1'); }catch(e){}
    });
    modal.querySelector('.x').addEventListener('click', closeGuide);
    modal.addEventListener('click', function(e){ if(e.target === modal) closeGuide(); });

  getBtn.addEventListener('click', async function(){
  if (deferredPrompt){
    try{ deferredPrompt.prompt(); await deferredPrompt.userChoice; }catch(e){}
    deferredPrompt = null; hideBanner();
  } else if (isIOS){
    openGuide();
  } else {
    alert('Windows/Brave: Click the install icon in the address bar, or Menu → Apps → Install this site.');
  }
});


window.addEventListener('appinstalled', function(){
  hideBanner();
  try{ sessionStorage.setItem('a2hs_dismissed','1'); }catch(e){}
});


 window.addEventListener('load', function(){
  var dismissed = '0';
  try{ dismissed = sessionStorage.getItem('a2hs_dismissed') || '0'; }catch(e){}
  if (isStandalone() || dismissed === '1') return;

  if (isIOS){
    setTimeout(safeShowBanner, 600); // iOS: always show guide banner
  } else {
    setTimeout(function(){           // Desktop/Brave fallback
      if (!deferredPrompt) safeShowBanner();
    }, 6000);
  }
});


  })();

  /* PWA */
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    });
  }

  /* boot */
  window.addEventListener("load", () => {
    $("y").textContent = new Date().getFullYear();
    bindOutputs();

   bindCfgInputs();
   renderFormulas();

    // Show cached price instantly (no waiting on network)
    try{
      const last = JSON.parse(localStorage.getItem(SPOT_KEY) || "null");
      if (last && isFinite(last.p)) {
        $("oz").value = Number(last.p).toFixed(2);
        runAll();
        setLastUpdated(new Date(last.t || Date.now()));
      }
    }catch{}

    setAuto(true); // background refresh every 10s (and runs once now)
  });
  </script>
</body>
</html>
